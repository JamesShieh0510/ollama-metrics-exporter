# 需要手動按 Run Query 的問題解決方案

## 問題描述

Dashboard 需要手動點擊 "Run queries" 才能顯示數值，無法自動執行查詢。

## 可能的原因和解決方案

### 1. Dashboard 刷新設置（最常見）

**檢查步驟**：
1. 在 Dashboard 右上角，找到刷新按鈕（圓形箭頭圖標）
2. 確認刷新間隔是否設置為 "10s" 或更短
3. **如果顯示 "Off"**，點擊並選擇一個刷新間隔（如 "10s"）

**重要**：即使 Dashboard JSON 中設置了 `"refresh": "10s"`，用戶界面中可能還是顯示 "Off"，需要手動啟用。

### 2. 瀏覽器阻止自動刷新

某些瀏覽器擴展或設置可能會阻止頁面自動刷新：

**解決方法**：
1. 禁用廣告攔截器或其他可能阻止刷新的擴展
2. 嘗試使用無痕模式
3. 檢查瀏覽器控制台是否有錯誤

### 3. Grafana 用戶設置

**檢查步驟**：
1. 點擊右上角用戶頭像 → **Preferences**
2. 檢查 **"Auto refresh"** 設置
3. 確認沒有全局設置阻止自動刷新

### 4. 查詢緩存問題

**解決方法**：
1. 在 Dashboard 中，點擊任意面板 → **Edit**
2. 在 **Query** 標籤中，找到 **Query options**
3. 檢查 **Cache time** 設置
4. 嘗試設置為 `0` 或較短的時間

### 5. Prometheus 數據源設置

**檢查步驟**：
1. **Configuration** → **Data Sources** → 選擇 Prometheus
2. 檢查 **Query timeout** 設置（建議設置為 60s 或更長）
3. 檢查 **HTTP Method** 設置（建議使用 POST）
4. 確認 **Scrape interval** 設置正確

### 6. 強制啟用自動刷新

**方法 1：通過 UI**
1. 在 Dashboard 右上角點擊刷新按鈕
2. 選擇 "10s" 或 "5s"
3. 確認刷新按鈕不是灰色

**方法 2：通過 URL 參數**
在 Dashboard URL 後添加 `?refresh=10s`：
```
http://your-grafana:3000/d/ollama-metrics?refresh=10s
```

**方法 3：通過 Dashboard 設置**
1. 點擊 Dashboard 設置（齒輪圖標）
2. 在 **General** 標籤中
3. 找到 **Auto refresh** 設置
4. 選擇 "10s" 或更短

### 7. 檢查 Grafana 版本

某些舊版本的 Grafana 可能有自動刷新的 bug：

**檢查方法**：
1. 點擊用戶頭像 → **Help** → **About**
2. 查看 Grafana 版本
3. 如果是舊版本（< 8.0），考慮升級

### 8. 檢查網絡連接

確認：
1. Grafana 服務器可以正常訪問 Prometheus
2. 沒有網絡延遲或超時問題
3. 防火牆沒有阻止連接

## 快速診斷步驟

1. **檢查刷新按鈕狀態**：
   - ✅ 刷新按鈕顯示 "10s" 且不是灰色
   - ❌ 如果顯示 "Off" 或灰色，需要手動啟用

2. **測試自動刷新**：
   - 等待 10 秒，觀察數據是否自動更新
   - 如果沒有更新，檢查瀏覽器控制台

3. **檢查查詢執行**：
   - 打開瀏覽器開發者工具（F12）
   - 查看 **Network** 標籤
   - 確認每 10 秒有查詢請求發送到 Prometheus

4. **檢查 Grafana 日誌**：
   - 查看 Grafana 服務器日誌
   - 確認沒有錯誤訊息

## 臨時解決方案

如果自動刷新無法修復，可以：

1. **使用瀏覽器擴展**：
   - 安裝自動刷新擴展（如 "Auto Refresh"）
   - 設置每 10 秒刷新頁面

2. **使用書籤工具**：
   - 創建一個帶有刷新參數的書籤
   - URL: `http://your-grafana:3000/d/ollama-metrics?refresh=10s`

3. **使用 Grafana API**：
   - 通過 API 定期查詢數據
   - 或使用外部工具監控

## 驗證修復

修復後應該：
- ✅ Dashboard 右上角顯示刷新間隔（如 "10s"）
- ✅ 刷新按鈕是活動狀態（不是灰色）
- ✅ 數據每 10 秒自動更新
- ✅ 不需要手動點擊 "Run queries"
- ✅ 瀏覽器 Network 標籤顯示定期查詢請求

## 如果問題仍然存在

請提供以下信息：
1. Grafana 版本
2. 瀏覽器類型和版本
3. 瀏覽器控制台的錯誤訊息
4. Grafana 服務器日誌
5. 刷新按鈕的狀態（顯示什麼）

